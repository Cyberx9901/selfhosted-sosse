stages:
  - test
  - build

before_script:
  - echo 'sudo --preserve-env=PYTHONPATH -u www-data python3-coverage run -a --source se,sosse ./sosse/sosse_admin.py "$@"' > /tmp/sudo_sosse
  - chmod 755 /tmp/sudo_sosse

debian-unittest:
  image: biolds/sosse:deb-test
  stage: test
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    paths:
      - se/migrations/*.py
      - htmlcov/*
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  script:
    - /etc/init.d/postgresql start
    - mkdir -p /var/lib/sosse/screenshots/ /var/lib/sosse/downloads/0 && chown -R www-data:www-data /var/lib/sosse/
    - /usr/bin/python3 /root/httpbin/httpbin/manage.py runserver 0.0.0.0:8000 &
    - export PYTHONPATH="$CI_PROJECT_DIR"
    - /tmp/sudo_sosse default_conf | sed -e "s/^#db_pass=.*/db_pass=sosse/" -e "s/^#debug=.*/debug=true/" -e "s/^#browser_options=\(.*\)/browser_options=\1 --no-sandbox/" -e "s/#dl_check_time=.*/dl_check_time=1/" > /etc/sosse/sosse.conf
    - /tmp/sudo_sosse test -v3 --failfast
    - /tmp/sudo_sosse load_se tests/opensearch.xml
    - /tmp/sudo_sosse update_se
    - /tmp/sudo_sosse shell -c 'from django.contrib.auth.models import User; User.objects.all().delete()'
    - /tmp/sudo_sosse default_admin
    - /tmp/sudo_sosse generate_secret
    - python3 ./sosse/sosse_admin.py makemigrations
    - python3-coverage report
    - python3-coverage html
    - python3-coverage xml

setuptools:
  image: biolds/sosse:pip-base
  artifacts:
    paths:
      - dist/*
  stage: build
  script:
    - echo "SOSSE_VERSION_TAG = '$CI_COMMIT_TAG'" >> sosse/settings.py
    - echo "SOSSE_VERSION_COMMIT = '${CI_COMMIT_SHORT_SHA}'" >> sosse/settings.py
    - make _setuptools
    - make _setuptools_test

migrations:
  image: biolds/sosse:deb-test
  stage: test
  script:
    - /etc/init.d/postgresql start
    - export PYTHONPATH="$CI_PROJECT_DIR"
    - /tmp/sudo_sosse default_conf | sed -e "s/^#db_pass=.*/db_pass=sosse/" -e "s/^#debug=.*/debug=true/" > /etc/sosse/sosse.conf
    - MIGRATION_COUNT="$(ls se/migrations/*.py|grep '/[0-9]'|wc -l)"
    - python3 ./sosse/sosse_admin.py makemigrations
    - MIGRATION_COUNT2="$(ls se/migrations/*.py|grep '/[0-9]'|wc -l)"
    - test "$MIGRATION_COUNT" -eq "$MIGRATION_COUNT2"

static_checks:
  image: biolds/sosse:deb-test
  stage: test
  script:
    - flake8 --ignore=E501,W503,W504 --exclude=migrations
    - 'for f in $(find -name \*.py|grep -v /__init__\.py$) ; do grep -q "^# Copyright" "$f" || echo "File $f does not have a copyright header" ; done'
    - 'for f in $(find -name \*.py|grep -v /__init__\.py$) ; do grep -q "^# Copyright" "$f" || exit 1 ; done'

debian-pkg:
  image: registry.gitlab.com/biolds1/sosse/debian-pkg:latest
  stage: build
  artifacts:
    paths:
      - deb/*.deb
  script:
    - cd "$CI_PROJECT_DIR"
    - rm -rf htmlcov
    - echo "SOSSE_VERSION_TAG = '$CI_COMMIT_TAG'" >> sosse/settings.py
    - echo "SOSSE_VERSION_COMMIT = '${CI_COMMIT_SHORT_SHA}'" >> sosse/settings.py
    - mkdir /deb
    - make _deb
    - mv /deb .

doc:
  image: biolds/sosse:doc
  stage: build
  artifacts:
    paths:
      - doc/build/*
  script:
    - make _build_doc
